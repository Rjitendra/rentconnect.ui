<div class="table-wrapper" [class.responsive]="options().responsive">
  <table
    mat-table
    [dataSource]="dataSource"
    matSort
    class="mat-elevation-z8"
    [class.auto-width]="options().autoWidth"
    [class.fixed-layout]="options().fixedLayout"
    multiTemplateDataRows
  >
    <!-- Checkbox Column -->
    @if (headerCheckbox() || rowCheckbox()) {
      <ng-container matColumnDef="select">
        <th
          mat-header-cell
          *matHeaderCellDef
          style="width: 50px; min-width: 50px"
        >
          @if (headerCheckbox()) {
            <mat-checkbox
              (change)="toggleAllRows()"
              [checked]="isAllSelected()"
              [indeterminate]="selection.hasValue() && !isAllSelected()"
              [aria-label]="checkboxLabel()"
            />
          }
        </th>
        <td mat-cell *matCellDef="let row" style="width: 50px; min-width: 50px">
          @if (rowCheckbox()) {
            <mat-checkbox
              (click)="$event.stopPropagation()"
              (change)="toggleRow(row)"
              [checked]="selection.isSelected(row)"
              [aria-label]="checkboxLabel(row)"
            />
          }
        </td>
      </ng-container>
    }

    <!-- Expand/Collapse Column -->
    @if (expandableRows()) {
      <ng-container matColumnDef="expand">
        <th
          mat-header-cell
          *matHeaderCellDef
          aria-label="row actions"
          style="width: 50px; min-width: 50px"
        >
          &nbsp;
        </th>
        <td mat-cell *matCellDef="let row" style="width: 50px; min-width: 50px">
          <button
            mat-icon-button
            aria-label="expand row"
            (click)="
              toggleRowExpansion(row, expandKey()); $event.stopPropagation()
            "
            class="expand-toggle-button"
            [class.expand-toggle-button-expanded]="
              isRowExpanded(row, expandKey())
            "
          >
            <mat-icon>keyboard_arrow_down</mat-icon>
          </button>
        </td>
      </ng-container>
    }

    <!-- Dynamic Columns -->
    @for (col of columns(); track col.key) {
      <ng-container [matColumnDef]="col.key">
        <!-- Header -->
        <th
          mat-header-cell
          *matHeaderCellDef
          [style.text-align]="col.headerAlign || col.align || 'left'"
          [class.column-selected]="selectedColumn === col.key"
          (click)="onColumnClick(col.key)"
        >
          {{ col.label }}
        </th>

        <!-- Row -->
        <td
          mat-cell
          *matCellDef="let element"
          (click)="onCellClick($event, element)"
          [style.text-align]="col.align || 'left'"
          [class.column-selected]="selectedColumn === col.key"
        >
          @if (col.template) {
            <ng-container
              *ngTemplateOutlet="
                col.template;
                context: { $implicit: element, row: element }
              "
            />
          } @else {
            {{ element[col.key] }}
          }
        </td>
      </ng-container>
    }

    <!-- Expanded Detail Column -->
    @if (expandableRows()) {
      <ng-container matColumnDef="expandedDetail">
        <td
          mat-cell
          *matCellDef="let element"
          [attr.colspan]="displayedColumns.length"
        >
          <div
            class="element-detail-wrapper"
            [class.element-detail-wrapper-expanded]="
              isRowExpanded(element, expandKey())
            "
          >
            <div class="element-detail">
              @if (expandedRowTemplate()) {
                <ng-container
                  *ngTemplateOutlet="
                    expandedRowTemplate();
                    context: { $implicit: element }
                  "
                />
              }
            </div>
          </div>
        </td>
      </ng-container>
    }

    <!-- Header Row -->
    <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>

    <!-- Regular Row -->
    <tr
      mat-row
      *matRowDef="let row; columns: displayedColumns"
      class="element-row"
      [class.expanded-row]="expandableRows() && isRowExpanded(row, expandKey())"
      [class.row-selected]="selectedRow === row"
      [style.cursor]="expandableRows() ? 'pointer' : 'default'"
      (click)="onRowSelect(row)"
    ></tr>

    <!-- Expanded Detail Row -->
    @if (expandableRows()) {
      <tr
        mat-row
        *matRowDef="let row; columns: ['expandedDetail']"
        class="detail-row"
      ></tr>
    }
  </table>
</div>

<!-- Paginator -->
@if (isPaginator()) {
  <mat-paginator
    [pageSize]="options().pageSize || 10"
    [pageSizeOptions]="options().pageSizeOptions || [5, 10, 20]"
  />
}
