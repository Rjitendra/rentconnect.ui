<div class="issue-detail">
  <div class="header-section">
    <button type="button" class="back-button" (click)="goBack()">
      <ng-icon [name]="'arrow_back'" />
    </button>
    <div class="header-content">
      <h1>Issue Details</h1>
      <p>View and manage issue status and comments</p>
    </div>
  </div>

  @if (loading) {
    <div class="loading-container">
      <div class="loading-spinner"></div>
      <p>Loading issue details...</p>
    </div>
  }

  @if (!loading && issue) {
    <!-- Issue Header -->
    <ng-card class="issue-header-card">
      <div class="issue-header">
        <div class="issue-meta">
          <div class="issue-number">
            <span class="label">Issue #</span>
            <span class="value">{{ issue.ticketNumber || issue.id }}</span>
          </div>
          <div class="issue-category">
            <i class="material-icons">{{ getCategoryIcon(issue.category) }}</i>
            <span>{{ getCategoryLabel(issue.category) }}</span>
          </div>
          <div
            class="issue-priority"
            [attr.data-priority]="getPriorityClass(issue.priority)"
          >
            <span>{{ getPriorityLabel(issue.priority) }} Priority</span>
          </div>
        </div>
        <div
          class="issue-status"
          [attr.data-status]="getStatusClass(issue.currentStatus)"
        >
          <span>{{ getStatusLabel(issue.currentStatus) }}</span>
        </div>
      </div>

      <div class="issue-content">
        <h2>{{ issue.title }}</h2>
        <p class="description">{{ issue.description }}</p>

        <div class="issue-timeline">
          <div class="timeline-item">
            <i class="material-icons">schedule</i>
            <span
              >Created:
              {{ issue.dateCreated | date: "MMM dd, yyyy 'at' h:mm a" }}</span
            >
          </div>
          @if (issue.dateModified && issue.dateModified !== issue.dateCreated) {
            <div class="timeline-item">
              <i class="material-icons">update</i>
              <span
                >Last Updated:
                {{
                  issue.dateModified | date: "MMM dd, yyyy 'at' h:mm a"
                }}</span
              >
            </div>
          }
          @if (issue.dateResolved) {
            <div class="timeline-item resolved">
              <i class="material-icons">check_circle</i>
              <span
                >Resolved:
                {{
                  issue.dateResolved | date: "MMM dd, yyyy 'at' h:mm a"
                }}</span
              >
            </div>
          }
        </div>
      </div>
    </ng-card>

    <!-- Comments Section -->
    <ng-card class="comments-card">
      <div class="card-header">
        <i class="material-icons">chat</i>
        <h3>Comments & Updates</h3>
      </div>

      @if (comments.length > 0) {
        <div class="comments-list">
          @for (comment of comments; track comment.id) {
            <div
              class="comment-item"
              [class.tenant-comment]="
                comment.addedByType === CreatedByType.Tenant
              "
            >
              <div class="comment-header">
                <div class="comment-author">
                  <i class="material-icons">{{
                    comment.addedByType === CreatedByType.Tenant
                      ? "person"
                      : "business"
                  }}</i>
                  <span class="author-name">{{ comment.addedByName }}</span>
                  <span class="author-type">{{
                    comment.addedByType === CreatedByType.Tenant
                      ? "Tenant"
                      : "Landlord"
                  }}</span>
                </div>
                <div class="comment-date">
                  {{ comment.dateCreated | date: "MMM dd, yyyy 'at' h:mm a" }}
                </div>
              </div>
              <div class="comment-content">
                <p>{{ comment.comment }}</p>
                @if (comment.attachments && comment.attachments.length > 0) {
                  <div class="comment-attachments">
                    <span class="attachments-label">Attachments:</span>
                    @for (
                      attachment of comment.attachments;
                      track attachment.id
                    ) {
                      <a
                        class="attachment-link"
                        target="_blank"
                        [href]="attachment.fileUrl"
                      >
                        <i class="material-icons">attach_file</i>
                        {{ attachment.fileName }}
                      </a>
                    }
                  </div>
                }
              </div>
            </div>
          }
        </div>
      } @else {
        <div class="empty-comments">
          <i class="material-icons">chat_bubble_outline</i>
          <p>No comments yet</p>
          <p class="sub-text">
            Add a comment below to communicate about this issue
          </p>
        </div>
      }

      <!-- Add Comment Form -->
      @if (
        issue.currentStatus !== TicketStatusType.Closed &&
        issue.currentStatus !== TicketStatusType.Cancelled
      ) {
        <div class="add-comment-section">
          <h4>Add Comment</h4>
          <form [formGroup]="commentForm" (ngSubmit)="onSubmitComment()">
            <div class="form-group">
              <ng-textarea
                label="Your Comment"
                placeholder="Add a comment or update about this issue..."
                formControlName="comment"
                [required]="true"
                [rows]="3"
              />
            </div>

            <div class="form-group">
              <ng-label
                [label]="'Attach Files (Optional)'"
                [toolTip]="'Upload files related to this issue'"
                [required]="false"
              />
              <ng-file-upload
                id="file-upload"
                [config]="fileUploadConfig"
                (filesSelected)="onFilesSelected($event)"
                (fileRemoved)="onFileRemoved($event.file)"
              />
            </div>

            <div class="form-actions">
              <ng-button
                buttonType="submit"
                [type]="'filled'"
                [label]="
                  isSubmittingComment ? 'Adding Comment...' : 'Add Comment'
                "
                [icon]="isSubmittingComment ? 'hourglass_empty' : 'send'"
                [disabled]="commentForm.invalid || isSubmittingComment"
              />
            </div>
          </form>
        </div>
      } @else {
        <div class="issue-closed-notice">
          <i class="material-icons">info</i>
          <span
            >This issue has been
            {{
              issue.currentStatus === TicketStatusType.Closed
                ? "closed"
                : "cancelled"
            }}. No further comments can be added.</span
          >
        </div>
      }
    </ng-card>

    <!-- Status History -->
    @if (issue.statusHistory && issue.statusHistory.length > 0) {
      <ng-card class="status-history-card">
        <div class="card-header">
          <i class="material-icons">history</i>
          <h3>Status History</h3>
        </div>

        <div class="status-timeline">
          @for (status of issue.statusHistory; track status.id) {
            <div class="timeline-item">
              <div
                class="timeline-marker"
                [attr.data-status]="getStatusClass(status.status)"
              >
                <i class="material-icons">{{ getStatusIcon(status.status) }}</i>
              </div>
              <div class="timeline-content">
                <div class="status-change">
                  <span class="status-label">{{
                    getStatusLabel(status.status)
                  }}</span>
                  <span class="status-date">{{
                    status.dateCreated | date: "MMM dd, yyyy 'at' h:mm a"
                  }}</span>
                </div>
                <div class="status-author">
                  by {{ status.addedByName }} ({{
                    status.addedByType === CreatedByType.Tenant
                      ? "Tenant"
                      : "Landlord"
                  }})
                </div>
                @if (status.comment) {
                  <p class="status-comment">{{ status.comment }}</p>
                }
              </div>
            </div>
          }
        </div>
      </ng-card>
    }
  }

  @if (!loading && !issue) {
    <div class="error-state">
      <i class="material-icons">error_outline</i>
      <h2>Issue Not Found</h2>
      <p>
        The requested issue could not be found or you don't have permission to
        view it.
      </p>
      <ng-button
        [type]="'filled'"
        [label]="'Go Back to Issues'"
        [icon]="'arrow_back'"
        (buttonClick)="goBack()"
      />
    </div>
  }
</div>
