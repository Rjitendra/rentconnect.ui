<div class="property-dashboard">
  <!-- Breadcrumb Navigation -->
  @if (currentView !== "table") {
    <div class="breadcrumb">
      <ng-button
        buttonType="button"
        type="text"
        label="Back to Properties"
        icon="arrow_back"
        (buttonClick)="goToTableView()"
      />
      <span class="divider">/</span>
      <span class="current-view">
        {{
          currentView === "detail"
            ? "Property Details"
            : currentView === "create"
              ? "Create Property"
              : "Edit Property"
        }}
      </span>
    </div>
  }
  @if (currentView === "table") {
    <!-- Page Header -->
    <div class="dashboard-header">
      <div class="header-content">
        <h1>Property Management</h1>
        <p>Manage your property portfolio with advanced features</p>
      </div>

      <div class="header-actions">
        <ng-button
          buttonType="button"
          type="filled"
          label="Add New Property"
          icon="add"
          cssClass="create-btn"
          (buttonClick)="onCreateProperty()"
        />
      </div>
    </div>
  }

  <!-- Table View -->
  @if (currentView === "table") {
    <div class="table-view">
      <!-- Table Statistics -->
      <div class="stats-cards">
        <div class="stat-card">
          <ng-icon name="home" class="stat-icon" />
          <div class="stat-content">
            <span class="stat-number">{{ properties.length }}</span>
            <span class="stat-label">Total Properties</span>
          </div>
        </div>
        <div class="stat-card">
          <ng-icon name="check_circle" class="stat-icon available" />
          <div class="stat-content">
            <span class="stat-number">{{ getAvailablePropertiesCount() }}</span>
            <span class="stat-label">Available</span>
          </div>
        </div>
        <div class="stat-card">
          <ng-icon name="people" class="stat-icon occupied" />
          <div class="stat-content">
            <span class="stat-number">{{ getOccupiedPropertiesCount() }}</span>
            <span class="stat-label">Occupied</span>
          </div>
        </div>
        <div class="stat-card">
          <ng-icon name="attach_money" class="stat-icon revenue" />
          <div class="stat-content">
            <span class="stat-number"
              >â‚¹{{ getTotalRevenue() || 0 | number: "1.0-0" }}</span
            >
            <span class="stat-label">Monthly Revenue</span>
          </div>
        </div>
      </div>
      <!-- Property Table -->
      <div class="table-section">
        @if (properties$ | async) {
          <div class="table-container">
            <ng-mat-table
              class="property-table"
              [data]="properties"
              [columns]="tableColumns"
              [options]="tableOptions"
              [isPaginator]="true"
            />
          </div>
        }
      </div>
    </div>
  }
  <!-- Property Detail Component -->
  @if (currentView === "detail") {
    <div>
      <app-property-detail
        [selectedProperties]="selectedProperty"
        (backToList)="goToTableView()"
      />
    </div>
  }
  <!-- Property Add/Edit Component -->
  <!-- Property Add/Edit Component -->
  @if (currentView === "create" || currentView === "edit") {
    <div>
      <app-property-add
        [property]="selectedProperty"
        (backToList)="goToTableView()"
      />
    </div>
  }

  <!-- Enhanced Document Upload Modal -->
  @if (showUploadModal) {
    <div class="upload-modal-overlay" (click)="onCloseUploadModal()">
      <div class="upload-modal" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <div class="header-content">
            <ng-icon name="upload_file" class="header-icon" />
            <div>
              <h3>Upload Property Documents</h3>
              @if (selectedPropertyForUpload) {
                <p>Add documents for {{ selectedPropertyForUpload.title }}</p>
              }
            </div>
          </div>
          <button
            type="button"
            class="close-btn"
            title="Close"
            (click)="onCloseUploadModal()"
          >
            <ng-icon name="close" />
          </button>
        </div>

        <div class="modal-content">
          @if (selectedPropertyForUpload) {
            <div class="property-info">
              <ng-icon name="home" class="property-icon" />
              <div class="property-details">
                <span class="property-title">{{
                  selectedPropertyForUpload.title
                }}</span>
                <span class="property-address"
                  >{{ selectedPropertyForUpload.city }},
                  {{ selectedPropertyForUpload.state }}</span
                >
              </div>
            </div>
          }

          <div class="upload-section">
            <!-- Document Category Selection -->
            <div class="form-section">
              <ng-select
                label="Document Category"
                placeholder="Select the appropriate document category"
                suffixIcon="category"
                class="category-field"
                [options]="documentCategoryOptions"
                [required]="true"
                [(ngModel)]="selectedDocumentCategory"
              />

              @if (selectedDocumentCategory) {
                <div class="category-info">
                  <div class="info-card">
                    <ng-icon class="category-icon" [name]="getIcon()" />
                    <div class="info-text">
                      <h4>{{ getLabel() }}</h4>
                      <p>{{ getHint() }}</p>
                    </div>
                  </div>
                </div>
              }
            </div>

            <!-- File Upload Component -->
            @if (selectedDocumentCategory) {
              <div class="form-section">
                <ng-file-upload
                  [label]="'Upload ' + categoryInfo.label"
                  [dragText]="
                    'Drop ' +
                    categoryInfo.label +
                    ' files here or click to browse'
                  "
                  [hint]="categoryInfo.hint"
                  [config]="documentUploadConfig"
                  [disabled]="isUploading"
                  [(ngModel)]="selectedUploadFiles"
                  (filesSelected)="onFilesSelected($event)"
                  (fileRemoved)="onFileRemoved($event)"
                  (uploadError)="onFileUploadError($event)"
                />
              </div>
            }

            <!-- Upload Instructions -->
            <div class="upload-instructions">
              <h5>Upload Guidelines:</h5>
              <ul>
                <li><strong>File Size:</strong> Maximum 10MB per file</li>
                <li>
                  <strong>File Types:</strong> PDF, DOC, DOCX, JPG, PNG only
                </li>
                <li>
                  <strong>Multiple Files:</strong> You can upload up to 10 files
                  at once
                </li>
                <li>
                  <strong>Quality:</strong> Ensure documents are clear and
                  readable
                </li>
                <li>
                  <strong>Category:</strong> Select the correct category for
                  better organization
                </li>
              </ul>
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <ng-button
            buttonType="button"
            type="text"
            label="Cancel"
            [disabled]="isUploading"
            (buttonClick)="onCloseUploadModal()"
          />
          <ng-button
            buttonType="button"
            type="filled"
            [label]="isUploading ? 'Uploading...' : 'Upload Documents'"
            [icon]="isUploading ? 'hourglass_empty' : 'upload'"
            [disabled]="
              !selectedDocumentCategory ||
              selectedUploadFiles.length === 0 ||
              isUploading
            "
            (buttonClick)="onUploadFiles()"
          />
        </div>
      </div>
    </div>
  }

  <!-- Document Download Category Modal -->
  @if (showDownloadModal) {
    <div class="download-modal-overlay" (click)="onCloseDownloadModal()">
      <div class="download-modal" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>Download Documents</h3>
          <ng-icon
            name="close"
            type="button"
            class="icon-clickable"
            (click)="onCloseDownloadModal()"
          />
        </div>
        <div class="modal-content">
          @if (selectedPropertyForDownload) {
            <div class="property-info">
              <ng-icon name="home" />
              <div class="property-details">
                <span class="property-title">{{
                  selectedPropertyForDownload.title
                }}</span>
                <span class="property-address"
                  >{{ selectedPropertyForDownload.city }},
                  {{ selectedPropertyForDownload.state }}</span
                >
              </div>
            </div>
          }
          <div class="download-section">
            <!-- Document Category Selection -->
            <div class="category-selection">
              <ng-select
                label="Select Download Category"
                placeholder="Choose which category of documents to download"
                class="category-field"
                [options]="downloadCategories"
                [required]="true"
                [(ngModel)]="selectedDownloadCategory"
              />
            </div>
            @if (selectedDownloadCategory) {
              <div class="download-preview">
                <div class="preview-info">
                  <ng-icon name="download" class="preview-icon" />
                  <div class="preview-details">
                    <h4>Download Preview</h4>
                    @if (selectedDownloadCategory === "all") {
                      <p>
                        You will download all
                        {{ getAllDocumentsCount() }} documents for this
                        property.
                      </p>
                    }
                    @if (selectedDownloadCategory !== "all") {
                      <p>
                        You will download {{ getSelectedCategoryCount() }}
                        {{ getSelectedCategoryLabel() }} documents.
                      </p>
                    }
                  </div>
                </div>
              </div>
            }
            <div class="download-instructions">
              <h5>Download Information:</h5>
              <ul>
                <li>
                  <strong>Multiple Downloads:</strong> Files will be downloaded
                  one by one
                </li>
                <li>
                  <strong>File Names:</strong> Original file names will be
                  preserved
                </li>
                <li>
                  <strong>File Types:</strong> PDF, DOC, DOCX, JPG, PNG
                  supported
                </li>
                <li>
                  <strong>Download Location:</strong> Files will be saved to
                  your default downloads folder
                </li>
              </ul>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <ng-button
            buttonType="button"
            type="text"
            label="Cancel"
            (buttonClick)="onCloseDownloadModal()"
          />
          <ng-button
            buttonType="button"
            type="filled"
            icon="download"
            [label]="
              'Download ' +
              (selectedDownloadCategory === 'all' ? 'All' : '') +
              ' Documents'
            "
            [disabled]="isDownloadDisabled()"
            (buttonClick)="onDownloadSelectedCategory()"
          />
        </div>
      </div>
    </div>
  }
</div>

<!-- Property Name Template -->
<ng-template #propertyNameTemplate let-property>
  <a
    href="javascript:void(0)"
    class="property-link"
    (click)="onViewProperty(property)"
  >
    <ng-icon name="home" class="property-icon icon-primary" />
    {{ property.title }}
  </a>
</ng-template>

<!-- Tenant Template -->
<ng-template #tenantTemplate let-property>
  <div class="tenants-cell">
    @if (getTenantsList(property).length > 0) {
      <!-- Show first tenant with profile -->
      @for (tenant of getTenantsList(property) | slice: 0 : 1; track tenant) {
        <div class="tenant-profile">
          <div class="tenant-avatar">
            <ng-icon name="person" class="tenant-icon icon-secondary" />
          </div>
          <div class="tenant-info">
            <span class="tenant-name">{{ tenant.name }}</span>
          </div>
          <!-- View all button -->
          <ng-icon
            name="visibility"
            tooltip="View All Tenants"
            class="tenant-view-icon icon-info icon-clickable"
            [ngMenuTriggerFor]="tenantMenu"
          />
        </div>
      }

      @if (getTenantsList(property).length > 1) {
        <span class="more-tenants"
          >+{{ getTenantsList(property).length - 1 }} more</span
        >
      }
    } @else {
      <!-- No tenants -->
      <div class="no-tenants">
        <ng-icon name="person_off" class="no-tenant-icon" />
        <span class="no-tenant-text">No Tenants</span>
      </div>
    }

    <!-- Tenant Menu -->
    <ng-menu #tenantMenu="ng-menu" panelClass="tenant-menu-panel">
      <div class="tenant-menu-header">
        <h4>Tenants for {{ property.title }}</h4>
      </div>
      <div class="tenant-list">
        @for (tenant of getTenantsList(property); track tenant) {
          <div class="tenant-item">
            <div
              class="tenant-info"
              (click)="onTenantSelect(tenant); $event.stopPropagation()"
            >
              <div class="tenant-primary">
                <ng-icon name="person" class="tenant-icon" />
                <div class="tenant-details">
                  <span class="tenant-name">{{ tenant.name }}</span>
                  @if (tenant.age) {
                    <span class="tenant-meta">{{ tenant.age }} years old</span>
                  }
                  <div class="tenant-badges">
                    @if (tenant.isPrimary) {
                      <span class="badge primary">Primary</span>
                    }
                    @if (tenant.isActive) {
                      <span class="badge active">Active</span>
                    }
                    @if (tenant.isVerified) {
                      <span class="badge verified">Verified</span>
                    }
                  </div>
                </div>
              </div>
              <!-- Tenant Children -->
              @if (getTenantChildren(tenant).length > 0) {
                <div class="tenant-children">
                  <div class="children-header">
                    <ng-icon name="child_care" />
                    <span>Family Members</span>
                  </div>
                  @for (child of getTenantChildren(tenant); track child) {
                    <div class="child-item">
                      <ng-icon name="person" class="child-icon" />
                      <span class="child-name">{{ child.name }}</span>
                      <span class="child-relation"
                        >({{ child.relation }}, {{ child.age }} years)</span
                      >
                    </div>
                  }
                </div>
              }
            </div>
            <ng-divider />
          </div>
        }
      </div>
    </ng-menu>
  </div>
</ng-template>

<!-- Document Template -->
<ng-template #documentTemplate let-property>
  <div class="documents-cell">
    <div class="document-actions">
      <div class="document-info-wrapper">
        <ng-icon name="description" class="document-main-icon icon-warning" />
        <span class="document-count-text"
          >{{ getPropertyDocuments(property).length }} docs</span
        >
      </div>

      <!-- Download Documents -->
      @if (getPropertyDocuments(property).length > 0) {
        <ng-icon
          name="download"
          tooltip="Download Documents"
          class="document-download-icon icon-accent icon-clickable"
          (click)="handleDownloadClick(property)"
        />
      }

      <!-- Upload Documents -->
      <ng-icon
        name="upload"
        tooltip="Upload Document"
        class="document-upload-icon icon-success icon-clickable"
        (click)="handleUploadClick(property)"
      />
    </div>
  </div>
</ng-template>

<!-- Status Template -->
<ng-template #statusTemplate let-property>
  <div
    class="status-chip"
    [ngClass]="'status-' + getSimplifiedStatus(property.status).toLowerCase()"
  >
    <ng-icon
      [class]="'status-icon' + getSimplifiedStatusIconColor(property.status)"
      [name]="getStatusIcon(property.status)"
    />
    {{ getSimplifiedStatus(property.status) }}
  </div>
</ng-template>

<!-- Actions Template -->
<ng-template #actionTemplate let-property>
  <div class="action-container">
    <ng-icon
      name="visibility"
      tooltip="View Details"
      class="icon-purple icon-clickable"
      (click)="onViewProperty(property)"
    />
    <ng-icon
      name="edit"
      tooltip="Edit Property"
      class="icon-orange icon-clickable"
      (click)="onEditProperty(property)"
    />
    <ng-icon
      name="delete"
      tooltip="Delete Property"
      class="icon-error icon-clickable"
      (click)="onDeleteProperty(property)"
    />
  </div>
</ng-template>
