<div class="tenant-add-form">
  <!-- Dynamic Header -->
  <div class="form-header">
    <div class="header-content">
      <ng-icon
        name="arrow_back"
        class="arrow_back"
        matTooltip="Go back to property list"
        (click)="onCancel()"
      />
      <div>
        <h1>{{ getFormTitle() }}</h1>
        <p>{{ getFormDescription() }}</p>
      </div>
    </div>
    <ng-icon
      class="header-icon"
      [name]="
        mode === 'add' ? 'person_add' : mode === 'edit' ? 'edit' : 'visibility'
      "
    />
  </div>

  <div class="tenant-form-container">
    <form [formGroup]="tenantForm" (ngSubmit)="onSubmit()">
      <!-- Property & Tenancy Details Card (Shared for all tenants) -->
      <ng-card
        title="Property & Tenancy Details"
        icon="home"
        class="form-card shared-details"
      >
        <div class="form-row">
          <ng-select
            class="full-width"
            formControlName="propertyId"
            label="Link Property"
            placeholder="Select property to link"
            suffixIcon="home"
            [options]="propertyOptions"
            [disabled]="isLoadingProperties"
          />
          @if (isLoadingProperties) {
            <div class="loading-indicator">
              <ng-icon name="hourglass_empty" class="icon-secondary" />
              Loading properties...
            </div>
          }
        </div>

        <div class="form-row">
          <ng-input
            class="third-width"
            formControlName="rentAmount"
            label="Total Rent Amount"
            placeholder="25000"
            suffixText="₹"
            [type]="InputType.Number"
          />

          <ng-input
            class="third-width"
            formControlName="securityDeposit"
            label="Security Deposit"
            placeholder="50000"
            suffixText="₹"
            [type]="InputType.Number"
          />

          <ng-input
            class="third-width"
            formControlName="maintenanceCharges"
            label="Maintenance"
            placeholder="2000"
            suffixText="₹"
            [type]="InputType.Number"
          />
        </div>

        <div class="form-row">
          <ng-datepicker
            class="third-width"
            formControlName="tenancyStartDate"
            label="Tenancy Start Date"
            placeholder="Select date"
          />

          <ng-datepicker
            class="third-width"
            formControlName="rentDueDate"
            label="Rent Due Date"
            placeholder="Select date"
          />

          <ng-input
            class="third-width"
            formControlName="leaseDuration"
            label="Lease Duration"
            placeholder="12"
            suffixText="months"
            [type]="InputType.Number"
          />
        </div>
      </ng-card>

      <!-- Tenants Section -->
      <div class="tenants-section">
        <div class="tenants-header">
          <h2>
            <ng-icon name="people" class="icon-primary" />
            Tenants ({{ tenantsFormArray.length }})
          </h2>
          @if (mode === "add") {
            <button type="button" class="add-tenant-btn" (click)="addTenant()">
              <ng-icon name="person_add" class="icon-white" />
              Add Tenant
            </button>
          }
        </div>

        <!-- Tenant Forms Array -->
        <div formArrayName="tenants">
          @for (
            tenantForm of tenantsFormArray.controls;
            track tenantForm;
            let i = $index
          ) {
            <div
              class="tenant-form-group"
              [formGroupName]="i"
              [class.disabled-tenant]="!isTenantEditable(i)"
            >
              <!-- Tenant Header -->
              <div class="tenant-header">
                <div class="tenant-title">
                  <h3>
                    <ng-icon
                      [name]="
                        getTenantFormGroup(i).get('isPrimary')?.value
                          ? 'star'
                          : 'person'
                      "
                      [class]="
                        getTenantFormGroup(i).get('isPrimary')?.value
                          ? 'icon-warning'
                          : 'icon-secondary'
                      "
                    />
                    Tenant {{ i + 1 }}
                    @if (getTenantFormGroup(i).get("isPrimary")?.value) {
                      <span class="primary-badge"> Primary </span>
                    }
                  </h3>
                </div>
                <div class="tenant-actions">
                  @if (
                    mode === "add" &&
                    !getTenantFormGroup(i).get("isPrimary")?.value
                  ) {
                    <button
                      type="button"
                      class="primary-btn"
                      title="Set as primary tenant"
                      (click)="setPrimaryTenant(i)"
                    >
                      <ng-icon name="star" class="icon-warning" />
                    </button>
                  }
                  @if (mode === "add" && tenantsFormArray.length > 1) {
                    <button
                      type="button"
                      class="remove-btn"
                      title="Remove tenant"
                      (click)="removeTenant(i)"
                    >
                      <ng-icon name="person_remove" class="icon-danger" />
                    </button>
                  }
                  @if (mode !== "add") {
                    <div class="tenant-mode-indicator">
                      @if (getTenantFormGroup(i).get("isPrimary")?.value) {
                        <span class="primary-indicator">
                          <ng-icon name="star" class="icon-warning" />
                          Primary Tenant
                        </span>
                      }
                      @if (!isTenantEditable(i)) {
                        <span class="readonly-indicator">
                          <ng-icon name="lock" class="icon-secondary" />
                          Read Only
                        </span>
                      }
                    </div>
                  }
                </div>
              </div>
              <!-- Personal Information -->
              <ng-card
                title="Personal Information"
                icon="person"
                class="tenant-card"
              >
                <div class="form-row">
                  <ng-input
                    class="half-width"
                    formControlName="name"
                    label="Full Name"
                    placeholder="Enter tenant's full name"
                    suffixIcon="person"
                    [disabled]="!isTenantEditable(i)"
                  />
                  <ng-input
                    class="half-width"
                    formControlName="email"
                    label="Email Address"
                    placeholder="tenant@example.com"
                    suffixIcon="email"
                    [disabled]="!isTenantEditable(i)"
                  />
                </div>
                <div class="form-row">
                  <ng-input
                    class="half-width"
                    formControlName="phoneNumber"
                    label="Phone Number"
                    placeholder="+91 9876543210"
                    suffixIcon="phone"
                    [disabled]="!isTenantEditable(i)"
                  />
                  <ng-datepicker
                    class="half-width"
                    formControlName="dob"
                    label="Date of Birth"
                    placeholder="Select date"
                  />
                </div>
                <div class="form-row">
                  <ng-input
                    class="half-width"
                    formControlName="occupation"
                    label="Occupation"
                    placeholder="Software Engineer"
                    suffixIcon="work"
                  />
                </div>
              </ng-card>
              <!-- Government IDs -->
              <ng-card
                title="Government IDs (Required)"
                icon="badge"
                class="tenant-card"
              >
                <div class="form-row">
                  <ng-input
                    class="half-width"
                    formControlName="aadhaarNumber"
                    label="Aadhaar Number"
                    placeholder="1234 5678 9012"
                    suffixIcon="credit_card"
                  />
                  <ng-input
                    class="half-width"
                    formControlName="panNumber"
                    label="PAN Number"
                    placeholder="ABCDE1234F"
                    suffixIcon="credit_card"
                  />
                </div>
              </ng-card>
              <!-- Emergency Contact -->
              <ng-card
                title="Emergency Contact"
                icon="contact_emergency"
                class="tenant-card"
              >
                <div class="form-row">
                  <ng-input
                    class="third-width"
                    formControlName="emergencyContactName"
                    label="Contact Name"
                    placeholder="Emergency contact name"
                    suffixIcon="person"
                  />
                  <ng-input
                    class="third-width"
                    formControlName="emergencyContactPhone"
                    label="Contact Phone"
                    placeholder="+91 9876543210"
                    suffixIcon="phone"
                  />
                  <ng-input
                    class="third-width"
                    formControlName="emergencyContactRelation"
                    label="Relationship"
                    placeholder="Father, Mother, etc."
                    suffixIcon="family_restroom"
                  />
                </div>
              </ng-card>
              <!-- Document Upload for this tenant -->
              <ng-card
                icon="upload_file"
                class="tenant-card"
                [title]="
                  'Documents for ' +
                  (getTenantFormGroup(i).get('name')?.value ||
                    'Tenant ' + (i + 1))
                "
              >
                <div class="document-upload-section">
                  <!-- Upload Summary -->
                  <div class="upload-summary">
                    <div class="summary-stats">
                      <div class="stat-item">
                        <ng-icon name="description" class="stat-icon" />
                        <span class="stat-text">
                          {{ getUploadedDocumentsCount(i) }} documents uploaded
                        </span>
                      </div>
                      @if (getUploadedDocumentsCount(i) > 0) {
                        <div class="stat-item">
                          <ng-icon name="category" class="stat-icon" />
                          <span class="stat-text">
                            {{ getUploadedCategories(i).length }} categories
                          </span>
                        </div>
                      }
                    </div>

                    <!-- Upload Button -->
                    <button
                      type="button"
                      class="upload-documents-btn"
                      title="Upload documents"
                      (click)="openDocumentUploadModal(i)"
                    >
                      <ng-icon name="add" class="btn-icon" />
                      Add Documents
                    </button>
                  </div>

                  <!-- Uploaded Categories Display -->
                  @if (getUploadedDocumentsCount(i) > 0) {
                    <div class="uploaded-categories">
                      <h5>Uploaded Categories:</h5>
                      <div class="categories-list">
                        @for (
                          category of documentCategories;
                          track category.value
                        ) {
                          @if (
                            getDocumentsByCategory(i, category.value).length > 0
                          ) {
                            <div class="category-item">
                              <div class="category-header">
                                <div class="category-badge">
                                  <ng-icon
                                    class="category-icon"
                                    [name]="getCategoryIcon(category.value)"
                                  />
                                  <span class="category-name">{{
                                    category.label
                                  }}</span>
                                  <span class="file-count">
                                    {{
                                      getDocumentsByCategory(i, category.value)
                                        .length
                                    }}
                                  </span>
                                </div>
                                <button
                                  type="button"
                                  class="remove-category-btn"
                                  title="Remove all files from this category for this tenant"
                                  (click)="
                                    removeDocumentCategory(i, category.value)
                                  "
                                >
                                  <ng-icon name="delete" />
                                </button>
                              </div>

                              <!-- Individual Files List -->
                              <!-- <div class="files-list">
                                @for (
                                  file of getDocumentsByCategory(
                                    i,
                                    category.value
                                  );
                                  track file.url
                                ) {
                                  <div class="file-item">
                                    <div class="file-info">
                                      <ng-icon
                                        class="file-icon"
                                        [name]="getFileIcon(file.type || '')"
                                      />
                                      <span
                                        class="file-name"
                                        [title]="file.name"
                                      >
                                        {{ file.name }}
                                      </span>
                                      <span class="file-size">
                                        {{ formatFileSize(file.size || 0) }}
                                      </span>
                                    </div>
                                    <button
                                      type="button"
                                      class="remove-file-btn"
                                      title="Remove this file"
                                      (click)="
                                        onDocumentCategoryRemoved(
                                          file,
                                          i,
                                          category.value
                                        )
                                      "
                                    >
                                      <ng-icon name="close" />
                                    </button>
                                  </div>
                                }
                              </div> -->
                            </div>
                          }
                        }
                      </div>
                    </div>
                  }

                  <!-- Upload Instructions -->
                  @if (getUploadedDocumentsCount(i) === 0) {
                    <div class="upload-instructions">
                      <ng-icon name="info" class="info-icon" />
                      <p>
                        Click "Add Documents" to upload documents by category.
                        Each category can have multiple files.
                      </p>
                    </div>
                  }
                </div>
              </ng-card>
            </div>
          }
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="action-buttons">
        <button
          type="button"
          class="cancel-btn"
          title="Cancel and go back"
          (click)="onCancel()"
        >
          <ng-icon name="cancel" class="icon-secondary" />
          Cancel
        </button>

        <button
          type="submit"
          class="save-btn"
          [title]="mode === 'edit' ? 'Update tenants' : 'Save all tenants'"
          [disabled]="tenantForm.invalid || isSaving || mode === 'detail'"
        >
          <ng-icon
            class="icon-white"
            [name]="
              isSaving ? 'hourglass_empty' : mode === 'edit' ? 'update' : 'save'
            "
          />
          {{
            mode === "detail"
              ? "View Only"
              : isSaving
                ? mode === "edit"
                  ? "Updating..."
                  : "Saving..."
                : mode === "edit"
                  ? "Update " +
                    tenantsFormArray.length +
                    (tenantsFormArray.length === 1 ? " Tenant" : " Tenants")
                  : "Add " +
                    tenantsFormArray.length +
                    " Tenant" +
                    (tenantsFormArray.length > 1 ? "s" : "")
          }}
        </button>
      </div>
    </form>
  </div>
</div>
