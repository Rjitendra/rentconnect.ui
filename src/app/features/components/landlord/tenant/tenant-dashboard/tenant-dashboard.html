<div class="tenant-dashboard">
  <!-- Page Header -->
  @if (currentView === "table") {
    <div class="dashboard-header">
      <div class="header-content">
        <div>
          <h1>Tenant Management</h1>
          <p>Manage your tenants, agreements, and onboarding process</p>
        </div>
      </div>
      <div class="header-actions">
        <ng-button
          buttonType="button"
          type="filled"
          label="Add New Tenant"
          icon="add"
          cssClass="create-btn"
          (buttonClick)="onAddTenant()"
        />
      </div>
    </div>
  }

  <!-- Table View -->
  @if (currentView === "table") {
    <div class="table-view">
      <!-- Statistics Cards -->
      <div class="stats-cards">
        <div class="stat-card">
          <ng-icon name="people" class="stat-icon" />
          <div class="stat-content">
            <span class="stat-number">{{ tenants.length }}</span>
            <span class="stat-label">Total Tenants</span>
          </div>
        </div>
        <div class="stat-card">
          <ng-icon name="check_circle" class="stat-icon active" />
          <div class="stat-content">
            <span class="stat-number">{{ getActiveTenants() }}</span>
            <span class="stat-label">Active Tenants</span>
          </div>
        </div>
        <div
          class="stat-card clickable-card"
          (click)="onSendAllOnboardingEmails()"
        >
          <ng-icon name="pending" class="stat-icon pending" />
          <div class="stat-content">
            <span class="stat-number">{{ getPendingOnboarding() }}</span>
            <span class="stat-label">Pending Onboarding</span>
            <span class="stat-sublabel">Click to send all</span>
          </div>
        </div>
        <div class="stat-card">
          <ng-icon name="attach_money" class="stat-icon revenue" />
          <div class="stat-content">
            <span class="stat-number"
              >₹{{ getTotalRentAmount() | number: "1.0-0" }}</span
            >
            <span class="stat-label">Monthly Rent</span>
          </div>
        </div>
      </div>

      <!-- Tenant Table with NgMatTable -->
      <div class="table-section">
        @if (initDashBoard$ | async) {
          <ng-mat-table
            [columns]="tableColumns"
            [data]="primaryTenants"
            [options]="tableOptions"
            [expandableRows]="true"
            [expandedRowTemplate]="expandedRowTemplate"
            [expandKey]="'id'"
            [isPaginator]="false"
            (rowClick)="onRowClick($any($event))"
            (rowExpand)="onRowExpand($any($event))"
          />
        }
      </div>
    </div>
  }

  <!-- Add Tenant Form -->
  @if (currentView === "add") {
    <div class="form-view">
      <app-tenant-add
        [initialMode]="'add'"
        (tenantAdded)="onTenantAdded()"
        (cancelled)="onTenantAddCancelled()"
      />
    </div>
  }

  <!-- Edit Tenant Form -->
  @if (currentView === "edit") {
    <div class="form-view">
      <app-tenant-add
        [initialMode]="'edit'"
        [tenantsToEdit]="editMode === 'group' ? editingTenants : []"
        [singleTenantToEdit]="
          editMode === 'single' ? editingSingleTenant : null
        "
        (tenantAdded)="onTenantEdited()"
        (cancelled)="showTable()"
      />
    </div>
  }

  <!-- Detail Tenant View -->
  @if (currentView === "detail") {
    <div class="form-view">
      <app-tenant-add
        [initialMode]="'detail'"
        [tenantsToEdit]="editingTenants"
        [singleTenantToEdit]="editingSingleTenant"
        (tenantAdded)="showTable()"
        (cancelled)="showTable()"
      />
    </div>
  }
</div>

<!-- Template for expanded row content -->
<ng-template #expandedRowTemplate let-tenant>
  <div class="expanded-content">
    <!-- Wrap both sections in flex -->
    <div class="expanded-row">
      <!-- Property Information Section -->
      <div class="expanded-header">
        <div class="property-section">
          <div class="section-title">
            <ng-icon name="home" class="section-icon" />
            <h4>Property Information</h4>
          </div>
          <div class="property-details">
            <div class="detail-item">
              <span class="label">Property:</span>
              <span class="value">{{
                getPropertyName(tenant.propertyId)
              }}</span>
            </div>
            <div class="detail-item">
              <span class="label">Rent Amount:</span>
              <span class="value highlight">
                ₹{{ tenant.rentAmount | number }}
              </span>
            </div>
            <div class="detail-item">
              <span class="label">Security Deposit:</span>
              <span class="value">₹{{ tenant.securityDeposit | number }}</span>
            </div>
            <div class="detail-item">
              <span class="label">Lease Duration:</span>
              <span class="value">
                {{ tenant.leaseDuration || "N/A" }} months
              </span>
            </div>
          </div>
        </div>
      </div>

      <!-- Tenant Group Members Section -->
      <div class="tenant-group-section">
        <div class="section-title">
          <ng-icon name="people" class="section-icon" />
          <h4>
            Tenant Group Members ({{ getGroupMemberCount(tenant.tenantGroup) }})
          </h4>
        </div>

        <div class="tenant-members-grid">
          @for (
            member of getGroupMembers(tenant.tenantGroup);
            track member.id
          ) {
            <div class="member-card" [class.primary-member]="member.isPrimary">
              <div class="member-header">
                <div class="member-avatar">
                  <ng-icon
                    [name]="member.isPrimary ? 'star' : 'person'"
                    [class]="
                      member.isPrimary ? 'icon-primary' : 'icon-secondary'
                    "
                  />
                </div>
                <div class="member-info">
                  <div class="member-name">
                    <span>{{ member.name }}</span>
                    @if (member.isPrimary) {
                      <span class="primary-badge">Primary</span>
                    }
                  </div>
                  @if (member.isPrimary) {
                    <div class="member-status">
                      <ng-icon
                        class="status-icon"
                        [name]="getStatusIcon(member)"
                      />
                      <span [class]="getStatusClass(member)">
                        {{ getStatusText(member) }}
                      </span>
                    </div>
                  }
                </div>
              </div>

              <div class="member-details">
                <div class="contact-info">
                  <div class="contact-item">
                    <ng-icon name="email" class="contact-icon" />
                    <span>{{ member.email || "N/A" }}</span>
                  </div>
                  <div class="contact-item">
                    <ng-icon name="phone" class="contact-icon" />
                    <span>{{ member.phoneNumber || "N/A" }}</span>
                  </div>
                  <div class="contact-item">
                    <ng-icon name="work" class="contact-icon" />
                    <span>{{ member.occupation || "N/A" }}</span>
                  </div>
                </div>

                <!-- Member Actions -->
                <div class="member-actions">
                  @if (!member.agreementSigned && member.isPrimary) {
                    <ng-icon
                      name="description"
                      tooltip="Create Agreement"
                      class="icon-teal icon-clickable"
                      (click)="onCreateAgreement(member)"
                    />
                  }
                  @if (
                    member.agreementSigned &&
                    member.agreementEmailSent &&
                    !member.agreementAccepted &&
                    member.isPrimary
                  ) {
                    <ng-icon
                      name="schedule"
                      tooltip="Waiting for Agreement Acceptance"
                      class="icon-warning"
                    />
                  }
                  @if (member.agreementAccepted && member.isPrimary) {
                    <ng-icon
                      name="verified"
                      tooltip="Agreement Accepted"
                      class="icon-success"
                    />
                  }
                  @if (isGroupAgreementAccepted(member.tenantGroup)) {
                    <ng-icon
                      name="send"
                      [tooltip]="
                        member.onboardingEmailSent
                          ? 'Resend Onboarding Email'
                          : 'Send Onboarding Email'
                      "
                      [class]="
                        member.onboardingEmailSent
                          ? 'icon-warning icon-clickable'
                          : 'icon-success icon-clickable'
                      "
                      (click)="onSendOnboardingEmail(member)"
                    />
                  }
                  @if (member.onboardingEmailSent) {
                    <ng-icon
                      name="mark_email_read"
                      tooltip="Onboarding Email Previously Sent"
                      class="icon-info"
                    />
                  }

                  <ng-icon
                    name="visibility"
                    tooltip="View Details"
                    class="icon-purple icon-clickable"
                    (click)="onViewTenant(member)"
                  />
                  <ng-icon
                    name="edit"
                    tooltip="Edit Tenant"
                    class="icon-orange icon-clickable"
                    (click)="onEditTenant(member)"
                  />
                  <ng-icon
                    name="delete"
                    [tooltip]="
                      member.isPrimary
                        ? 'Delete Primary Tenant (Restricted)'
                        : 'Delete Tenant'
                    "
                    [class]="getDeleteIconClass(member)"
                    (click)="onDeleteTenant(member)"
                  />
                </div>
              </div>
            </div>
          }
        </div>
      </div>
    </div>
  </div>
</ng-template>

<!-- Actions Template for Table Row -->
<ng-template #actionTemplate let-member>
  <div class="action-container">
    <ng-icon
      name="visibility"
      tooltip="View Group Details"
      class="icon-purple icon-clickable"
      (click)="onViewTenant(member)"
    />
    <ng-icon
      name="edit"
      tooltip="Edit All Group Members"
      class="icon-orange icon-clickable"
      (click)="onEditTenantGroup(member)"
    />
    @if (!member.agreementSigned) {
      <ng-icon
        name="description"
        tooltip="Create Agreement"
        class="icon-teal icon-clickable"
        (click)="onCreateAgreement(member)"
      />
    }
    @if (
      member.agreementSigned &&
      member.agreementEmailSent &&
      !member.agreementAccepted
    ) {
      <ng-icon
        name="schedule"
        tooltip="Waiting for Agreement Acceptance"
        class="icon-warning"
      />
    }
    @if (isGroupAgreementAccepted(member.tenantGroup)) {
      <ng-icon
        name="send"
        [tooltip]="
          member.onboardingEmailSent
            ? 'Resend Onboarding Email'
            : 'Send Onboarding Email'
        "
        [class]="
          member.onboardingEmailSent
            ? 'icon-warning icon-clickable'
            : 'icon-success icon-clickable'
        "
        (click)="onSendBulkOnboardingEmails(member.propertyId)"
      />
    }
    @if (member.onboardingEmailSent) {
      <ng-icon
        name="mark_email_read"
        tooltip="Onboarding Email Previously Sent"
        class="icon-info"
      />
    }
    <ng-icon
      name="delete"
      [tooltip]="
        member.isPrimary
          ? 'Delete Primary Tenant Group (Restricted)'
          : 'Delete Tenant Group'
      "
      [class]="getDeleteIconClass(member)"
      (click)="onDeleteTenant(member)"
    />
  </div>
</ng-template>
